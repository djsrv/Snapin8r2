<!DOCTYPE html>
<html>
  <head>
    <title>Snapin8r2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
    <script src="snapin8r2.js"></script>
    <script>
      window.addEventListener("load", function() {
        var dropzone = document.getElementById("dropzone");

        function handleDrop(e) {
          this.style.borderColor = "#eee";
          this.style.backgroundColor = "#fff";
          this.style.color = "#aaa";
          this.innerHTML = "Converting&hellip;";

          e.stopPropagation(); // Stops some browsers from redirecting.
          e.preventDefault();

          var file = e.dataTransfer.files[0];
          var reader = new FileReader();
          var projectName = file.name.replace(/.sb2$/, "");

          function conversionDone(err, result, warnings) {
            var el, li, msg;

            while (dropzone.firstChild) {
              dropzone.removeChild(dropzone.firstChild);
            }
            dropzone.style.color = "#000";

            if (err) {
              dropzone.style.backgroundColor = "#eaa";

              el = document.createElement("span");
              el.innerHTML = "Well, this is embarassing.<br/>The ancient geekish runes read:";
              dropzone.appendChild(el);

              dropzone.appendChild(document.createElement("br"));

              el = document.createElement("code");
              el.textContent = err;
              dropzone.appendChild(el);

              dropzone.appendChild(document.createElement("br"));

              el = document.createElement("span");
              el.innerHTML = "Chances are, this is a bug. Sorry! You can help us out by reporting this error.";
              dropzone.appendChild(el);

              throw err;
            } else {
              dropzone.style.backgroundColor = warnings ? "#eea" : "#aea";
              var linkColor = warnings ? "orange" : "green";

              el = document.createElement("span");
              el.innerHTML = "Believe it or not, it worked!"
              dropzone.appendChild(el);

              dropzone.appendChild(document.createElement("br"));

              if (warnings && warnings.length > 0) {
                el = document.createElement("span");
                el.innerHTML = "However, there were some warnings:";
                dropzone.appendChild(el);

                el = document.createElement("ul");
                for (var i = 0, l = warnings.length; i < l; i++) {
                  li = document.createElement("li");
                  msg = document.createElement("code");
                  msg.textContent = warnings[i];
                  li.appendChild(msg);
                  el.appendChild(li);
                }
                dropzone.appendChild(el);
              }

              el = document.createElement("a");
              el.style.color = linkColor;
              el.href = "http://snap.berkeley.edu/snapsource/snap.html#open:" + encodeURIComponent(result);
              el.innerHTML = "Click here to open your project!";
              dropzone.appendChild(el);

              dropzone.appendChild(document.createElement("br"));

              el = document.createElement("a");
              el.style.color = linkColor;
              el.href = URL.createObjectURL(new Blob([result], {
                type: "text/xml"
              }));
              el.innerHTML = "Click here to download your project!";
              el.download = projectName + ".xml";
              dropzone.appendChild(el);
            }
          }

          reader.onload = function(e) {
            Snapin8r(e.target.result, projectName, conversionDone);
          }
          reader.readAsArrayBuffer(file);
        }

        function handleDragEnter(e) {
          this.style.borderColor = "orange";
        }

        function handleDragLeave(e) {
          this.style.borderColor = "#eee";
        }

        function hangleDragOver(e) {
          if (e.preventDefault) {
            e.preventDefault();
          }
        }

        dropzone.addEventListener("drop", handleDrop, false);
        dropzone.addEventListener("dragenter", handleDragEnter, false);
        dropzone.addEventListener("dragleave", handleDragLeave, false);
        dropzone.addEventListener("dragover", hangleDragOver, false);
      }, false);
    </script>
    <style>
      html {
        padding: 0px;
        height: 100%;
      }

      * {
        box-sizing: border-box;
      }

      body {
        padding: 0px;
        margin: 0px;
        height: 100%;
        font-family: sans-serif;
      }

      #wrapper {
        width: 100%;
        height: 100%;
      }

      #left-column {
        width: 40%;
        padding: 10px;
        overflow-y: scroll;
        float: left;
        display: table;
      }

      #right-column {
        padding: 0px;
        float: left;
        width: 60%;
        height: 100%;
        padding: 10px;
        display: table;
      }

      #dropzone {
        border-style: dashed;
        border-radius: 30px;
        border-color: #eee;
        height: 100%;
        text-align: center;
        display: table-cell;
        vertical-align: middle;
        color: #aaa;
        padding: 10px;
      }

      p {
        text-indent: 10px;
      }

      h1, h2 {
        text-align: center;
      }

      ul {
        padding-left: 15px;
      }
    </style>
  </head>

  <body>
    <div id="wrapper">
      <div id="left-column">
        <h1>Snapin8r2</h1>
        <p>Snapin8r2 converts <a href="http://scratch.mit.edu">Scratch 2.0</a> projects to <a href="http://snap.berkeley.edu">Snap!</a> projects. This page lets you use the current development version of Snapin8r2 to convert your projects.</p>
        <p>It cannot convert certain unsupported blocks and warns when these are encountered.</p>
        <p>Furthermore, being on the bleeding edge means that you might get errors in conversion because of unresolved bugs&mdash;please report these <a href="https://github.com/djdolphin/Snapin8r2/issues">on Github</a>.</p>
        <h2>Credits</h2>
        <ul>
          <li>Snapin8r2 is based on <a href="http://hardmath123.github.io/Snapin8r/">Snapin8r</a> by <a href="http://hardmath123.github.io/">Hardmath123</a>.</li>
          <li>It was rewritten by <a href="https://scratch.mit.edu/users/djdolphin/">djdolphin</a> to (hopefully) work better.</a>
          </li>
          <li>It uses <a href="http://stuk.github.io/jszip/">JSZip</a> to read <code>.sb2</code> files.</li>
          <li>It contains SVG-handling code from <a href="http://phosphorus.github.io/">phosphorus</a> by <a href="https://github.com/nathan">Nathan Dinsmore</a>.</li>
        </ul>
      </div>
      <div id="right-column">
        <div id="dropzone">
          Drop a <code>.sb2</code> file here&hellip;
        </div>
      </div>
    </div>
  </body>
</html>
